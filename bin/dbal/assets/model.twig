<?php

namespace {{ namespace }};

use ReactApp\DBAL\Model;
use Drift\DBAL\Result;
use React\Promise\PromiseInterface;

class {{ model.name|db_to_camel }} extends Model
{
    protected string $_table = '{{ model.name }}';
    protected string $_model = self::class;

{% for column, info in model.columns %}
{% set nullable = (column == model.primary|first or (info.options.notnull is defined and info.options.notnull == false)) %}
    protected {% if nullable %}?{% endif %}{{ info.type|to_php_type }} ${{ column }}{% if nullable %} = null{% endif %};
{% endfor %}

    public function __construct(?int $id = null)
    {
        parent::__construct(json_decode('{{ model|json_encode|raw }}', true));
        if ($id !== null) {
            $this->get($id);
        }
    }

    public function getId(): ?int
    {
        return $this->{{ model.primary|first }};
    }

{% for column, info in model.columns %}
{% set nullable = (column == model.primary|first or (info.options.notnull is defined and info.options.notnull == false)) %}
    public function get{{ column|db_to_camel }}(): {% if nullable %}?{% endif %}{{ info.type|to_php_type }}
    {
        return $this->{{ column }};
    }

{% if column != model.primary|first %}
{% set nullable = (column == model.primary|first or (info.options.notnull is defined and info.options.notnull == false)) %}
    public function set{{ column|db_to_camel }}({% if nullable %}?{% endif %}{{ info.type|to_php_type }} ${{ column }}): self
    {
        $this->{{ column }} = ${{ column }};
        return $this;
    }
{% endif %}
{% endfor %}
{% if model.relations.many_to_many is not empty %}

{% for relation in model.relations.many_to_many %}
{% set many_to_many = model.name|many_to_many(relation) %}
    public function get{{ relation|db_to_camel }}s(): PromiseInterface
    {
        $queryBuilder = self::$connection->createQueryBuilder();
        $queryBuilder
            ->select('*')
            ->from('{{ relation }}', 'r')
            ->innerJoin('r', '{{ relation }}_of_{{ model.name }}', 'mtm', 'r.{{ relation }}_id = mtm.{{ relation }}_id')
            ->where('mtm.{{ model.name }}_id = ?')
            ->setParameters([$this->getId()]);
        return self::$connection
            ->query($queryBuilder)
            ->then(function(Result ${{ relation }}s) {
                $items = [];
                if (${{ relation }}s->fetchCount() > 0) {
                    foreach (${{ relation }}s->fetchAllRows() as ${{ relation }}) {
                        $items[] = (new {{ relation|db_to_camel }}())->populate(${{ relation }});
                    }
                }
                return $items;
            });
    }

    public function add{{ relation|db_to_camel }}({{ relation|db_to_camel }} ${{ relation }}): PromiseInterface
    {
        return self::$connection->insert('{{ relation }}_of_{{ model.name }}', [
            '{{ relation }}_id' => ${{ relation }}->getId(),
            '{{ model.name }}_id' => $this->getId(),
        ]);
    }

    public function remove{{ relation|db_to_camel }}({{ relation|db_to_camel }} ${{ relation }}): PromiseInterface
    {
        return self::$connection->delete('{{ relation }}_of_{{ model.name }}', [
            '{{ relation }}_id' => ${{ relation }}->getId(),
            '{{ model.name }}_id' => $this->getId(),
        ]);
    }
{% endfor %}
{% endif %}
{% if model.relations.one_to_many is not empty %}

{% for relation in model.relations.one_to_many %}
    public function get{{ relation|db_to_camel }}s(): PromiseInterface
    {
        return (new {{ relation|db_to_camel }}())->findBy(['{{ model.name }}_id' => $this->getId()]);
    }
{% endfor %}
{% endif %}
{% if model.relations.many_to_one is not empty %}

{% for relation in model.relations.many_to_one %}
    public function get{{ relation|db_to_camel }}(): PromiseInterface
    {
        return (new {{ relation|db_to_camel }}())->get($this->get{{ relation|db_to_camel }}Id());
    }

    public function set{{ relation|db_to_camel }}({{ relation|db_to_camel }} ${{ relation }}): PromiseInterface
    {
        $this->set{{ relation|db_to_camel }}Id(${{ relation }}->getId());
    }
{% endfor %}
{% endif %}
}
